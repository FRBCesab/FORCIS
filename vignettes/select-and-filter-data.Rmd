---
title: "Select, reshape, and filter data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Select, reshape, and filter data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  eval     = TRUE,
  echo     = TRUE,
  comment  = "#>",
  dpi       = 150,
  fig.align = "center",
  out.width = "90%"
)
```

The package `forcis` provides [a lot of functions](https://frbcesab.github.io/forcis/reference/index.html#select-and-filters-tools) to filter, reshape, and select FORCIS data. This vignette shows how to use these functions.


## Setup

First, let's import the required packages.

```{r setup}
library(forcis)
```

Before going any further, we will download the latest version of the FORCIS database.

```{r 'download-db', eval=FALSE}
# Create a data/ folder ----
dir.create("data")

# Download latest version of the database ----
download_forcis_db(path = "data", version = NULL)
```

The vignette will use the plankton nets data of the FORCIS database. Let's import the latest release of the data.

```{r 'load-data', echo=FALSE}
file_name <- system.file(file.path("extdata", "FORCIS_net_sample.csv"), package = "forcis")
net_data <- read.table(file_name, dec = ".", sep = ";")
```

```{r 'load-data-user', eval=FALSE}
# Import net data ----
net_data <- read_plankton_nets_data(path = "data")
```

**NB:** In this vignette, we use a subset of the plankton nets data, not the whole dataset.



## `select_taxonomy()`

The FORCIS database provides three different taxonomies: `LT` (lumped taxonomy), `VT` (validated taxonomy) and `OT` (original taxonomy). See the [associated data paper](https://doi.org/10.1038/s41597-023-02264-2) for further information.

After importing the data and before going any further, the next step involves choosing the taxonomic level for the analyses. Let's use the function `select_taxonomy()` to select the **VT** taxonomy (validated taxonomy):

```{r 'select-taxo'}
# Select taxonomy ----
net_data <- select_taxonomy(net_data, taxonomy = "VT")
```



## `select_columns()`

Because FORCIS data contains more than 100 columns, the function `select_columns()` can be used to lighten the `data.frame` to easily handle it and to speed up some computations. 

By default, only required columns listed in `get_required_columns()` and species columns will be kept.


```{r 'select-columns'}
# Select taxonomy ----
net_data <- select_columns(net_data)
```

You can also use the argument `cols` to keep additional columns.



## `reshape_data()`

This function converts FORCIS data in a long format.

```{r, eval=FALSE}
# Reshape net subset data to long format 
long_net_data <- reshape_data(net_data)

```



## `filter_by_month()`

The `filter_by_month()` function filters observations based on the **month of sampling**. It requires two arguments: the data and a numeric vector with values between 1 and 12.

```{r 'filter-by-month'}
# Filter data by sampling month ----
net_july_aug <- filter_by_month(net_data, months = 7:8)
```


```{r 'plot-by-month-original', fig.height=4, fig.width=7, fig.cap='Original record'}
# Plot original record by sampling month ----
plot_record_by_month(net_data)
```


```{r 'plot-by-month-filtered', fig.height=4, fig.width=7, fig.cap='Filtered record'}
# Plot filtered record by sampling month ----
plot_record_by_month(net_july_aug)
```



## `filter_by_year()`

The `filter_by_year()` function filters observations based on the **year of sampling**. It requires two arguments: the data and a numeric vector with the years of interest.

```{r 'filter-by-year'}
# Filter data by sampling year ----
net_90_20 <- filter_by_year(net_data, years = 1990:2020)
```


```{r 'plot-by-year-original', fig.height=4, fig.width=7, fig.cap='Original record'}
# Plot original record by sampling year ----
plot_record_by_year(net_data)
```


```{r 'plot-by-year-filtered', fig.height=4, fig.width=7, fig.cap='Filtered record'}
# Plot filtered record by sampling year ----
plot_record_by_year(net_90_20)
```


## `filter_by_bbox()`

Add an illustration of `filter_by_bbox()`

[...]



## `filter_by_ocean()`

Add an illustration of `filter_by_ocean()`

[...]



## `filter_by_polygon()`

Add an illustration of `filter_by_polygon()`

[...]


## `filter_by_species()`

This function allows to filter the data for one or more species. To work, this function requires data in a long format( see the `reshape_data` function and the [conversion functions](https://frbcesab.github.io/forcis/articles/data-conversion.html)).

The `filter_by_species()` function takes a dataframe and a species name or a vector of species names as input (the list of all the accepted  input species names are presented in the [FORCIS_taxonomy_levels.xlsx file on Zenodo](https://zenodo.org/records/12724286)).

In the example below we subset `long_net_data` to retain only observations on *G. glutinata* and *C. nitida*.

```{r, eval=FALSE}
# Convert species counts in raw abundance
glutinata_nitida_subset <- filter_by_species(long_net_data,c('g_glutinata_VT','c_nitida_VT'))

```
